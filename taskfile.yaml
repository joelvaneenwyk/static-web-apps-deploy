# yaml-language-server: $schema=https://json.schemastore.org/taskfile.json
# https://taskfile.dev
# brew install go-task

version: '3'

set: [pipefail]
shopt: [globstar]
dotenv:
  - .env

vars:
  DOCKER_IMAGE_NAME: 'static-web-apps-deploy'
  DOCKER_IMAGE_TAG: '{{ .DOCKER_IMAGE_NAME }}:stable'
  BUILD_DIR: '{{ .TASKFILE_DIR }}/.build'
  BIN_DIR: '{{ .BUILD_DIR }}/bin'

  BREW: '/home/linuxbrew/.linuxbrew/bin/brew'
  BREW_INSTALL_SCRIPT: '{{ .BIN_DIR }}/install-brew.sh'
  BREW_INSTALL_URI: 'https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh'

  RUN_WINDOWS: 'cmd /d /c'
  RUN_UNIX: 'sh -c'
  RUN: '{{if eq OS "windows"}}{{.RUN_WINDOWS}}{{ else }}{{.RUN_UNIX}}{{ end }}'

  DOTENV_VAULT: npx --yes dotenv-vault@latest

tasks:
  default:
    cmds:
      - task: build

  get-install-brew-script:
    deps: [init-build-directory]
    status:
      - test -f "{{ .BREW_INSTALL_SCRIPT }}"
    sources:
      - '{{ .BREW_INSTALL_URI }}'
    generates:
      - '{{ .BREW_INSTALL_SCRIPT }}'
    cmds:
      - cmd: |
          curl -fsSL "{{ .BREW_INSTALL_URI }}" >"{{ fromSlash .BREW_INSTALL_SCRIPT }}"
        platforms: [darwin, linux]
      - cmd: scoop install touch && touch "{{ fromSlash .BREW_INSTALL_SCRIPT }}"
        platforms: [windows]

  install-brew:
    deps: [get-install-brew-script]
    status:
      - test -f "{{ .BREW_INSTALL_SCRIPT }}"
      - test -f "{{ .BREW }}"
      - brew --version
    cmds:
      - cmd: |
          "{{ .BREW_INSTALL_SCRIPT }}"
          if [ -n "${GITHUB_PATH:-}" ]; then
            echo "/home/linuxbrew/.linuxbrew/bin" >> $GITHUB_PATH
            echo "/home/linuxbrew/.linuxbrew/sbin" >> $GITHUB_PATH
          fi
        platforms: [darwin, linux]

  install-sass:
    deps: [install-brew]
    status:
      - sass --embedded --version
    env:
      PATH: '${PATH}:/home/linuxbrew/.linuxbrew/bin:/home/linuxbrew/.linuxbrew/sbin'
    cmds:
      - cmd: '"{{ .BREW }}" install sass/sass/sass'
        platforms: [darwin, linux]
      - cmd: 'scoop install sass'
        platforms: [windows]

  init-build-directory:
    status:
      - test -d "{{ .BIN_DIR }}"
    cmds:
      - cmd: cmd /d /c mkdir "{{ .BUILD_DIR }}"
        platforms: [windows]
      - cmd: cmd /d /c mkdir "{{ .BIN_DIR }}"
        platforms: [windows]
      - cmd: mkdir -p "{{ .BIN_DIR }}"
        platforms: [linux, darwin]

  install-node-packages:
    status:
      - 'test -f "{{ .TASKFILE_DIR }}/package-lock.json"'
    sources:
      - '{{ .TASKFILE_DIR }}/package.json'
    generates:
      - '{{ .TASKFILE_DIR }}/package-lock.json'
      - '{{ .TASKFILE_DIR }}/node_modules/.bin/autoprefixer'
      - '{{ .TASKFILE_DIR }}/node_modules/.bin/prettier'
      - '{{ .TASKFILE_DIR }}/node_modules/.bin/postcss'
    cmds:
      - cmd: npm install

  rebuild:
    desc: Rebuild the Static Web Apps project.
    cmds:
      - task: delete
        vars: { TARGET: '{{ .TASKFILE_DIR }}/package-lock.json' }
      - task: build

  build:
    desc: Build the Static Web Apps project.
    deps: [install-sass, install-node-packages, init-build-directory]
    sources:
      - '{{ .TASKFILE_DIR }}/package.json'
      - '{{ .TASKFILE_DIR }}/package-lock.json'
      - '{{ .TASKFILE_DIR }}/test/hugo.toml'
      - '{{ .TASKFILE_DIR }}/test/themes/nightfall/theme.toml'
    generates:
      - '{{ .TASKFILE_DIR }}/test/public/index.html'
      - '{{ .TASKFILE_DIR }}/test/public/404.html'
    cmds:
      - cmd: npm run build

  format:
    desc: Automatically format all files with 'Prettier' command.
    deps: [build]
    cmds:
      - cmd: npm run format

  install-act:
    status:
      - act --version
    cmds:
      - cmd: 'brew install nektos/tap/act'
        platforms: [linux, darwin]
      - cmd: 'scoop install main/act'
        platforms: [windows]

  install-gh:
    status:
      - gh --version
    cmds:
      - cmd: 'brew install gh'
        platforms: [linux, darwin]
      - cmd: 'winget install --id GitHub.cli -scope machine'
        platforms: [windows]

  install-gh-act:
    deps: [install-gh, install-act]
    status:
      - gh act --version
    cmds:
      - cmd: gh extension install nektos/gh-act

  act:
    deps: [install-gh-act, dotenv-pull]
    desc: Run GitHub Actions locally.
    aliases: [a, gact, ghact]
    dotenv: ['.env']
    env:
      GIT_TERMINAL_PROMPT: 0
    vars:
      # build-and-push-image, test-local-github-action
      ACT_GH_JOB_NAME: test-local-github-action
      ACT_GH_TOKEN: '{{ .GITHUB_TOKEN | default "INVALID_TOKEN" }}'
      ACT_GH_USER: '{{ .GITHUB_USER | default "INVALID_USER" }}'
    cmds:
      - cmd: |
          echo "{{ .ACT_GH_TOKEN }}" | \
            docker login ghcr.io -u "{{ .ACT_GH_USER }}" --password-stdin
        silent: true
      - cmd: >-
          gh act
          -j="{{ .ACT_GH_JOB_NAME }}"
          -s GITHUB_TOKEN="{{ .ACT_GH_TOKEN }}"
          --replace-ghe-action-token-with-github-com "{{ .ACT_GH_TOKEN }}"
        silent: true

  dotenv-login:
    internal: true
    status:
      - 'test -f "{{ .TASKFILE_DIR }}/.env.me"'
    sources:
      - .env.vault
    generates:
      - .env.me
    cmds:
      - cmd: '{{ .DOTENV_VAULT }} login --yes'

  dotenv-push:
    internal: true
    deps: [dotenv-login]
    preconditions:
      - 'test -f "{{ .TASKFILE_DIR }}/.env"'
      - 'test -f "{{ .TASKFILE_DIR }}/.env.me"'
      - 'test -f "{{ .TASKFILE_DIR }}/.env.vault"'
    cmds:
      - cmd: '{{ .DOTENV_VAULT }} push --yes'

  dotenv-pull:
    deps: [dotenv-login]
    status:
      - 'test -f "{{ .TASKFILE_DIR }}/.env"'
    sources:
      - .env.vault
    generates:
      - .env
    cmds:
      - cmd: '{{ .DOTENV_VAULT }} pull --yes'

  pre-commit:
    desc: Run formatter and add files to 'git' automatically.
    deps: [format]
    cmds:
      - cmd: git add .

  bash:
    desc: Start an interactive shell session in Static Web Apps Docker container.
    aliases: [sh]
    interactive: true
    cmds:
      - task: docker
        vars: { CLI_ARGS: 'bash --login -c "{{ .CLI_ARGS }}"', INTERACTIVE: true }

  version:
    cmds:
      - task: docker
        vars: { ARGS: 'version' }

  delete:
    internal: true
    requires: { vars: [TARGET] }
    status:
      - 'test ! -d "{{.TARGET}}"'
      - 'test ! -f "{{.TARGET}}"'
    cmds:
      - task: delete-dir
        vars: { TARGET_DIR: '{{ .TARGET }}' }
      - task: delete-file
        vars: { TARGET_FILE: '{{ .TARGET }}' }

  delete-dir:
    internal: true
    requires: { vars: [TARGET_DIR] }
    status:
      - 'test ! -d "{{.TARGET_DIR}}"'
    cmds:
      - cmd: '{{.RUN}} if exist "{{ fromSlash .TARGET_DIR }}" rmdir /s /q "{{ fromSlash .TARGET_DIR }}"'
        platforms: [windows]
      - cmd: '{{.RUN}} rm -rf "{{.TARGET_DIR}}"'
        platforms: [linux, darwin]

  delete-file:
    internal: true
    requires: { vars: [TARGET_FILE] }
    status:
      - 'test ! -f "{{.TARGET_FILE}}"'
    cmds:
      - cmd: '{{.RUN}} if exist "{{fromSlash .TARGET_FILE}}" del "{{fromSlash .TARGET_FILE}}"'
        platforms: [windows]
      - cmd: '{{.RUN}} rm -f "{{.TARGET_FILE}}"'
        platforms: [linux, darwin]

  docker-build:
    internal: true
    deps: [build]
    aliases:
      - db
      - cb
    vars:
      DOCKERFILE_PATH: '{{ .TASKFILE_DIR }}/Dockerfile'
      DOCKER_BUILD_LOG_PATH: '{{ .BUILD_DIR }}/docker-build.log'
    env:
      DOCKER_BUILDKIT: 1
    status:
      - test -n "$(docker images -q "{{ .DOCKER_IMAGE_TAG }}")"
    sources:
      - '{{ .DOCKERFILE_PATH }}'
      - '{{ .TASKFILE_DIR }}/src/entrypoint.sh'
    generates:
      - '{{ .DOCKER_BUILD_LOG_PATH }}'
    cmds:
      - cmd: >-
          docker buildx build
          --file "{{ fromSlash .DOCKERFILE_PATH }}"
          -t "{{ .DOCKER_IMAGE_TAG}}"
          --progress plain
          "{{ fromSlash .TASKFILE_DIR }}"
          >"{{ fromSlash .DOCKER_BUILD_LOG_PATH }}"

  docker:
    aliases: [d, r, run]
    desc: Run the Static Web Apps Docker container.
    deps: [docker-build]
    vars:
      SKIP_DEPLOY_ON_MISSING_SECRETS: true
      SKIP_APP_BUILD: true
      DOCKER_APP_LOCATION: '/root/build'
      DOCKER_IMAGE: '{{ .DOCKER_IMAGE_TAG }}'
      INTERACTIVE: '{{coalesce .INTERACTIVE .CLI_ARGS}}'
      ARG_INTERACTIVE: '{{ if .INTERACTIVE }}-it{{ end }}'
      ARGS_DEFAULT: >-
        upload
        --skipAppBuild
        --app "{{ .DOCKER_APP_LOCATION }}"
        --apiToken "{{ .AZURE_STATIC_WEB_APPS_API_TOKEN }}"
      ARGS: '{{ coalesce .CLI_ARGS .ARGS_DEFAULT "" }}'
    cmds:
      - cmd: >-
          docker run
          --rm {{ .ARG_INTERACTIVE }}
          --volume "{{ .TASKFILE_DIR }}":"{{ .DOCKER_APP_LOCATION }}"
          --volume "{{ .TASKFILE_DIR }}/src/":"/admin/"
          --restart=no
          --log-driver local
          --log-opt max-size=10m
          --log-opt max-file=3
          --workdir "{{ .DOCKER_APP_LOCATION }}"
          --name "{{ .DOCKER_IMAGE_NAME }}"
          "{{ .DOCKER_IMAGE }}"
          {{ .ARGS }}

  static-apps-client:
    aliases: [sac, swa, s]
    desc: >-
      Run 'mcr.microsoft.com/appsvc/staticappsclient:stable' image directly so
      that we can quickly validate if there are any major differences between
      our image and the officially supported version.
    dotenv: [.env]
    vars:
      # As noted in 'https://github.com/Azure/static-web-apps/issues/679#issuecomment-1357799789' it is
      # expected that 'SKIP_DEPLOY_ON_MISSING_SECRETS' is an environment variable. This conflicts with
      # documentation which is logged against 'https://github.com/Azure/static-web-apps/issues/679'.
      SKIP_DEPLOY_ON_MISSING_SECRETS: true
      SKIP_APP_BUILD: true
      APP_LOCATION: '{{ .TASKFILE_DIR }}/test/public'
      DOCKER_APP_LOCATION: '/root/build'
      DOCKER_IMAGE: 'mcr.microsoft.com/appsvc/staticappsclient:stable'
    env:
      SKIP_DEPLOY_ON_MISSING_SECRETS: '{{ .SKIP_DEPLOY_ON_MISSING_SECRETS }}'
    cmds:
      - cmd: >-
          docker run
          --rm
          --entrypoint "/bin/staticsites/StaticSitesClient"
          --volume "{{ fromSlash .APP_LOCATION }}":"{{ .DOCKER_APP_LOCATION }}"
          {{ .DOCKER_IMAGE }}
          upload
          --app "{{ .DOCKER_APP_LOCATION }}"
          --apiToken "{{ .AZURE_STATIC_WEB_APPS_API_TOKEN }}"
